{% extends "layouts/intranet.html" %}
{% load static i18n %}

{% block page_wrapper_title %}
  <div class="row page-titles">
    <div class="col-md-5 align-self-center">
      <h4 class="text-themecolor">{% trans "Account Settings" %}</h4>
    </div>
    <div class="col-md-7 align-self-center text-right">
      <div class="d-flex justify-content-end align-items-center">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="{% url 'core_app:initial_page' %}">{% trans "Home" %}</a></li>
          <li class="breadcrumb-item active">{% trans "Email Management" %}</li>
        </ol>
      </div>
    </div>
  </div>
{% endblock page_wrapper_title %}

{% block page_wrapper_content %}
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <h4 class="card-title"><i class="fa fa-envelope"></i> {% trans "Email Addresses" %}</h4>
          <p class="card-subtitle">{% trans "The following email addresses are associated with your account:" %}</p>

          {% if user.emailaddress_set.all %}
            <div class="table-responsive m-t-20">
              <table class="table table-bordered table-striped">
                <thead>
                  <tr>
                    <th>{% trans "Email Address" %}</th>
                    <th>{% trans "Verified" %}</th>
                    <th>{% trans "Primary" %}</th>
                    <th>{% trans "Actions" %}</th>
                  </tr>
                </thead>
                <tbody>
                  {% for emailaddress in user.emailaddress_set.all %}
                    <tr>
                      <td>
                        <i class="fa fa-envelope-o"></i> {{ emailaddress.email }}
                      </td>
                      <td>
                        {% if emailaddress.verified %}
                          <span class="badge badge-success"><i class="fa fa-check"></i> {% trans "Verified" %}</span>
                        {% else %}
                          <span class="badge badge-warning"><i class="fa fa-exclamation-triangle"></i> {% trans "Not Verified" %}</span>
                        {% endif %}
                      </td>
                      <td>
                        {% if emailaddress.primary %}
                          <span class="badge badge-info"><i class="fa fa-star"></i> {% trans "Primary" %}</span>
                        {% else %}
                          <form method="post" action="{% url 'account_email' %}" style="display: inline;">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="primary">
                            <input type="hidden" name="email" value="{{ emailaddress.email }}">
                            <button type="submit" class="btn btn-sm btn-outline-info">
                              <i class="fa fa-star-o"></i> {% trans "Make Primary" %}
                            </button>
                          </form>
                        {% endif %}
                      </td>
                      <td>
                        {% if not emailaddress.verified %}
                          <form method="post" action="{% url 'account_email' %}" style="display: inline;">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="send">
                            <input type="hidden" name="email" value="{{ emailaddress.email }}">
                            <button type="submit" class="btn btn-sm btn-success">
                              <i class="fa fa-paper-plane"></i> {% trans "Re-send Verification" %}
                            </button>
                          </form>
                        {% endif %}

                        {% if not emailaddress.primary %}
                          <form method="post" action="{% url 'account_email' %}" style="display: inline;">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="remove">
                            <input type="hidden" name="email" value="{{ emailaddress.email }}">
                            <button type="submit" class="btn btn-sm btn-danger">
                              <i class="fa fa-trash"></i> {% trans "Remove" %}
                            </button>
                          </form>
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="alert alert-warning">
              <i class="fa fa-exclamation-triangle"></i> {% trans "You currently do not have any email addresses set up." %}
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <h4 class="card-title"><i class="fa fa-plus-circle"></i> {% trans "Add Email Address" %}</h4>
          <p class="card-subtitle">{% trans "Add an additional email address to your account." %}</p>

          <form method="post" action="{% url 'account_email' %}" class="m-t-20">
            {% csrf_token %}
            {{ form.as_p }}
            <button type="submit" name="action" value="add" class="btn btn-primary">
              <i class="fa fa-plus"></i> {% trans "Add Email" %}
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <h4 class="card-title"><i class="fa fa-lock"></i> {% trans "Other Account Settings" %}</h4>
          <div class="list-group">
            <a href="{% url 'account_change_password' %}" class="list-group-item list-group-item-action">
              <i class="fa fa-key"></i> {% trans "Change Password" %}
              <i class="fa fa-chevron-right float-right"></i>
            </a>
            <a href="{% url 'account_set_password' %}" class="list-group-item list-group-item-action">
              <i class="fa fa-lock"></i> {% trans "Set Password" %}
              <i class="fa fa-chevron-right float-right"></i>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock page_wrapper_content %}

{% block page_wrapper_right_sidebar %}
  {% include 'basepartials/page_wrapper_right_sidebar.html' %}
{% endblock page_wrapper_right_sidebar %}

{% block css %}
  <style>
    .table th {
      background-color: #f8f9fa;
      font-weight: 600;
    }
    .card-subtitle {
      color: #6c757d;
      margin-bottom: 1rem;
    }
    .list-group-item {
      border-left: 3px solid transparent;
    }
    .list-group-item:hover {
      border-left-color: #17a2b8;
      background-color: #f8f9fa;
    }
    /* Style allauth form fields */
    input[type="email"],
    input[type="text"] {
      width: 100%;
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    input[type="email"]:focus,
    input[type="text"]:focus {
      border-color: #17a2b8;
      outline: none;
      box-shadow: 0 0 0 0.2rem rgba(23, 162, 184, 0.25);
    }
    label {
      font-weight: 600;
      margin-bottom: 5px;
      display: block;
    }
  </style>
{% endblock css %}

{% block inline_javascript %}
  <script>
    $(function() {
      // Confirm before removing email
      $('button:contains("Remove")').on('click', function(e) {
        if (!confirm('{% trans "Are you sure you want to remove this email address?" %}')) {
          e.preventDefault();
        }
      });
    });
  </script>
{% endblock inline_javascript %}
